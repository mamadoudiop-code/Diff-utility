name: Comparaison PR et Filtrage Commits

on:
  pull_request:
    # Se déclenche lorsque la PR est ouverte, mise à jour (synchronize) ou rouverte
    types: [opened, synchronize, reopened] 

jobs:
  filtrer_commits_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout des branches
        uses: actions/checkout@v4
        with:
          # Crucial : Récupère l'historique complet pour la comparaison.
          fetch-depth: 0 
          # Récupère spécifiquement la branche de la PR (head)
          ref: ${{ github.event.pull_request.head.ref }} 

      - name: Lancer la Comparaison et le Filtrag
        id: filter_pr
        run: |
          # 1. Définir les références
          # La branche HEAD est la branche qui sera fusionnée (ex: 'feature/new').
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          # La branche BASE est la branche cible (ex: 'main').
          BASE_REF="origin/main"
          EXCLUSION_PATTERN="^Revert |\[skip build\]"
          
          
          echo "Comparaison : '$HEAD_REF' (prochaine fusion) vers '$BASE_REF' (cible)"
          
          # 2. Utiliser l API Git pour lister les commits uniques
          # Syntaxe : liste les commits présents dans HEAD_REF mais pas dans BASE_REF.
          # (C est l ensemble des nouveaux commits introduits par la PR).
          COMMITS_TO_CHECK=$(git log "$HEAD_REF" ^"$BASE_REF" --pretty=format:'%s' --no-merges)
          
          echo "--- Messages de commit à vérifier (excluant les merges) ---"
          echo "$COMMITS_TO_CHECK"
          echo "---------------------------------------------------------"
          
          # 3. Filtrer les messages de commit
          # On cherche les commits qui NE contiennent PAS le mot-clé d exclusion, par exemple, '[skip build]'.
          # -v : Inverse la sélection (ne garde PAS les lignes correspondantes)
          FILTERED_COMMITS=$(echo "$COMMITS_TO_CHECK" | grep -v -i -E "$EXCLUSION_PATTERN" || true)
          
          # 4. Définir les outputs
          if [ -z "$FILTERED_COMMITS" ]; then
            echo "✅ Tous les commits à fusionner sont marqués ou la liste est vide. Aucune action supplémentaire requise."
            echo "new_commits_found=false" >> $GITHUB_OUTPUT
          else
            echo "❌ Commits trouvés qui nécessitent un traitement :"
            echo "$FILTERED_COMMITS"
            echo "new_commits_found=true" >> $GITHUB_OUTPUT
            
            # Pour utiliser la liste dans une étape suivante
            echo "filtered_list<<EOF" >> $GITHUB_OUTPUT
            echo "$FILTERED_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Exécuter l Action Conditionnelle
        if: steps.filter_pr.outputs.new_commits_found == 'true'
        run: |
          echo "Déclenchement du build/test car des commits non ignorés ont été trouvés."
          # Ajoutez ici l'action souhaitée (build, déploiement, etc.)
