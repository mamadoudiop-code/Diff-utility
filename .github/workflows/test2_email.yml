name: G√©n√©rer et ARTEFA les Release Notes (Test)

on:
  workflow_dispatch:
      
jobs:
  build_and_send:
    runs-on: ubuntu-latest
      
    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4
        
      - name: üìÇ Pr√©parer le r√©pertoire de sortie
        # Cr√©e un r√©pertoire de travail pour la d√©mo
        run: mkdir -p ${{ runner.temp }}/gen-output
        
      - name: ‚öôÔ∏è Ex√©cuter le script de g√©n√©ration HTML
        id: generate_html
        shell: bash
        run: |
          # --- Variables de d√©mo (remplacez par les v√¥tres) ---
          DATE=$(date +'%Y-%m-%d')
          REVISION=$(git rev-parse --short HEAD)
          # Liste de JIRA pour la boucle de d√©mo (JIRA, SUMMARY, STATUS, REPORTER, RESPONSIBLE, CLIENTS)
          # On simule un STATUS_TEST diff√©rent pour chaque ligne
          JIRA_DATA=(
            "DEMO-123|Correction bug critique|DONE|Jean.R|Marie.L|Client A, Client B|PASSED"
            "DEMO-456|Nouvelle fonctionnalit√©|IN PROGRESS|Paul.A|Sophie.B|Client C|FAILED"
            "DEMO-789|Mise √† jour mineure|DONE|Lucas.C|Emma.D|Client D|NOTRUN"
            "DEMO-101|Am√©lioration UX|DONE|Chloe.E|Alex.F|Client A|PASSED"
          )
          
          OUTPUT_FILE="${{ runner.temp }}/gen-output/release_notes.html"
          
          # --- D√©but du script am√©lior√© ---

          cat << EOF > "$OUTPUT_FILE"
          <!DOCTYPE html>
          <html>
          <head>
            <title>Release Notes</title>
            <meta charset="UTF-8">
            <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
            <style>
              body {
                margin: 0;
                padding: 0;
                background-color: #f0f2f5; /* Un arri√®re-plan l√©g√®rement plus doux */
                font-family: 'Roboto', Arial, sans-serif; /* Police moderne */
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
              }
              .container {
                width: 650px; /* L√©g√®rement plus large pour plus d'espace */
                max-width: 90%; /* Responsif pour les petits √©crans */
                margin: 30px auto;
                background-color: #ffffff;
                border: 1px solid #e0e0e0;
                border-radius: 8px; /* Bords l√©g√®rement arrondis */
                overflow: hidden; /* Important pour les coins arrondis avec le header */
                box-shadow: 0 6px 15px rgba(0,0,0,0.1); /* Ombre plus prononc√©e */
              }
              .header-cell {
                background-color: #00703C !important;
                color: #ffffff !important;
                padding: 20px 25px !important; /* Plus de padding */
                font-size: 20px !important; /* Texte plus grand */
                font-weight: 700 !important; /* Plus gras */
                text-align: left !important; /* Alignement √† gauche */
                border-top-left-radius: 8px; /* Coins arrondis pour le header */
                border-top-right-radius: 8px;
              }
              .content-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px; /* Taille de police standard */
                color: #333333;
              }
              .content-table th, .content-table td {
                border: 1px solid #eeeeee; /* Bordures plus fines et plus claires */
                padding: 12px 15px; /* Plus de padding pour les cellules */
                text-align: left;
                vertical-align: top; /* Alignement en haut pour les contenus longs */
              }
              .content-table th {
                background-color: #f8f9fa; /* Fond des headers l√©g√®rement gris */
                color: #555555;
                font-weight: 700;
                text-transform: uppercase; /* Majuscules pour les titres de colonnes */
                font-size: 12px; /* Taille plus petite pour les en-t√™tes */
              }
              .content-table tr:nth-child(even) {
                background-color: #fdfdfd; /* Stripage l√©ger pour la lisibilit√© */
              }
              a {
                color: #00703C; /* Couleur Desjardins pour les liens */
                text-decoration: none;
                font-weight: 500;
              }
              a:hover {
                text-decoration: underline;
              }
            </style>
          </head>
          <body>
          <div class="container">
          
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td class="header-cell">
                RELEASE NOTES : Livraison d'identityiq, le ${DATE}, r√©vision: ${REVISION}
              </td>
            </tr>
          </table>
          
          <table class="content-table">
            <thead>
              <tr>
                <th style="width: 10%;">Num√©ro Jira</th>
                <th style="width: 30%;">Sommaire</th>
                <th style="width: 10%;">√âtat</th>
                <th style="width: 10%;">Rapporteur</th>
                <th style="width: 15%;">Responsable</th>
                <th style="width: 15%;">Clients</th>
                <th style="width: 10%;">Statut test</th>
              </tr>
            </thead>
            <tbody>
          EOF
          
          for DATA_STRING in "${JIRA_DATA[@]}"; do
              IFS='|' read JIRA_ID JIRA_SUMMARY JIRA_STATUS JIRA_REPORTER JIRA_RESPONSIBLE JIRA_CLIENTS STATUS_TEST <<< "$DATA_STRING"
              
              ROW_BG_COLOR="#ffffff" # Couleur par d√©faut (blanc)
              STATUS_BG_COLOR="#f7f7f7" # Gris clair par d√©faut
              STATUS_TEXT_COLOR="#333333"
          
              if [ "$STATUS_TEST" == "PASSED" ]; then
                  STATUS_BG_COLOR="#e8f5e9" # Vert plus doux
                  STATUS_TEXT_COLOR="#2e7d32" # Vert fonc√©
              elif [ "$STATUS_TEST" == "FAILED" ]; then
                  STATUS_BG_COLOR="#ffebee" # Rouge plus doux
                  STATUS_TEXT_COLOR="#c62828" # Rouge fonc√©
              elif [ "$STATUS_TEST" == "NOTRUN" ]; then
                  STATUS_BG_COLOR="#fffde7" # Jaune plus doux
                  STATUS_TEXT_COLOR="#f9a825" # Jaune fonc√©
              fi
              
              cat << JIRA_LINE_EOF >> "$OUTPUT_FILE"
              <tr>
                <td>
                  <a href="https://jira.desjardins.com/browse/${JIRA_ID}">${JIRA_ID}</a>
                </td>
                <td>${JIRA_SUMMARY}</td>
                <td>${JIRA_STATUS}</td>
                <td>${JIRA_REPORTER}</td>
                <td>${JIRA_RESPONSIBLE}</td>
                <td>${JIRA_CLIENTS}</td>
                <td style="background-color: ${STATUS_BG_COLOR}; color: ${STATUS_TEXT_COLOR}; font-weight: 700; text-align: center;">
                  ${STATUS_TEST}
                </td>
              </tr>
          JIRA_LINE_EOF
          done
          
          cat << EOF >> "$OUTPUT_FILE"
            </tbody>
          </table>
          </div>
          </body>
          </html>
          EOF          
          # On expose le chemin du fichier HTML pour l'√©tape suivante
          echo "html_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT

      - name: ‚¨ÜÔ∏è Archiver le fichier HTML comme Artefact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ github.run_id }}
          #path: ${{ steps.generate_html.outputs.html_path }}
          retention-days: 7 # Garde l'artefact pendant 7 jours
